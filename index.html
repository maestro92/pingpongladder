<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>BHG PingPong Ladder</title>
        <link rel="stylesheet" type="text/css" href="ladder.css">
        <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    	<script>
    	  // Initialize Firebase
            var config = {
            apiKey: "AIzaSyDvEu4Lb-bVbdI03Takb4ER5AJ_9aZbA-c",
            authDomain: "pingpongladder-6f7b2.firebaseapp.com",
            databaseURL: "https://pingpongladder-6f7b2.firebaseio.com",
            projectId: "pingpongladder-6f7b2",
            storageBucket: "pingpongladder-6f7b2.appspot.com",
            messagingSenderId: "8703643581"
            };
            firebase.initializeApp(config);


            	// Firebase permission denied
            // https://stackoverflow.com/questions/37403747/firebase-permission-denied
            // when you do this for the first time, you see see lots of "Get Started" Buttons
            // just ignore those. 
    	</script>
    </head>

    <body>
        <h2>Firebase Example</h2>
        <input type='text' id='newPlayerNameInput'  placeholder='Enter new Player Name here...'>

        <!-- we register the savedata here with the onclick function -->
        <button type="button" onclick="addNewUser()">Add New User</button>
        
        <!-- h1 h2 ... h6 are different HTML headings -->
        <!-- https://www.w3schools.com/tags/tag_hn.asp -->
        <h4>Current Players</h4>
        <ol id="currentPlayerList"></ol>

        <!-- ol defines and ordered list (just google it)-->

        <br><br><br>
        <hr>
        <h2>Results</h2>
        <textarea rows="10" cols="50" id="results"></textarea>
        <script>
            // var messagesRef = new Firebase('https://pingpongladder-6f7b2.firebaseio.com'); 

            var bhgPingPongLadderDB = firebase.database().ref(); 
            var newPlayerNameField = document.getElementById('newPlayerNameInput');

            var messageResults = document.getElementById('results');
            

            // Update results when data is added
            /*
            bhgPingPongLadderDB.limitToLast(10).on('child_added', function (snapshot) {
                var data = snapshot.val();
                console.log(snapshot.val());
                var message = data.text;
                if (message != undefined)
                {
                    messageResults.value += '\n' + message;
                }
            });
            */

            // this will get fired on initial load as well as whenever there is a change in the data
            // https://firebase.google.com/docs/database/admin/retrieve-data
            //      
            //      "we attach a Asynchronous listener to retrieve data. This listener is trigged once
            //      for the initial state of the data and again anytime the data changes. 

            bhgPingPongLadderDB.on("value", function (snapshot) {
                var data = snapshot.val();
                console.log(snapshot.val());
                var message = data.text;
                if (message != undefined)
                {
                    messageResults.value += '\n' + message;
                }

                var list = [];
                for (var key in data)
                {
                    if(data.hasOwnProperty(key))
                    {                        
                        name = data[key].name ? data[key].name : '';
                        if(name.trim().length > 0)
                        {
                            list.push({name: name, key: key})
                        }
                    }
                }

                refreshUI(list);
            });


            function addNewUser()
            {                                
                console.log("adding New User");
                var playerName = newPlayerNameField.value.trim();

                if(playerName.length > 0)
                {
                    saveToFirebase(playerName);        
                }

                newPlayerNameField.value = '';
            }

/*
            // Save data to firebase
            function addNewUser()
            {                                
                console.log("in here");
                var message = messageField.value;
                bhgPingPongLadderDB.push({fieldName:'messageField', text:message});
                messageField.value = '';
            }
*/


            // Saving Data to Firebase
            // https://firebase.google.com/docs/database/admin/save-data
            // this argument we passed into the push() function is essentially a JSON object
            function saveToFirebase(playerName)
            {
                bhgPingPongLadderDB.push({
                    name: playerName
                });
            }



            function refreshUI(list)
            {
                var lis = '';
                for(var i=0; i<list.length; i++)
                {
                    lis += '<li data-key="' + list[i].key + '">' + list[i].name + '</li>';
                };
                document.getElementById('currentPlayerList').innerHTML = lis;
            }

            function genLinks(key, playerName)
            {

            };

            function edit(key, playerName)
            {
                var playerNamePrompt = prompt("Update the playerName", playerName);
                if(playerNamePrompt && playerNamePrompt.length > 0)
                {
                    
                }
            };

            function del(key, playerName)
            {

            };

            function buildEndPoint (key)
            {

            };

            // tutorials used: 
            // http://thejackalofjavascript.com/getting-started-with-firebase/
            // https://deanhume.com/home/blogpost/a-basic-guide-to-firebase-for-the-web/10142


            // sign in the user before accessing the database
            // https://stackoverflow.com/questions/37403747/firebase-permission-denied
            // For a (slightly) more time-consuming, but more secure, solution, call one of the signIn... methods of Firebase Authentication to ensure the user is signed in before accessing the database
            // the simplest way to do this is using anonymous authentication

            /*
            firebase.auth().signInAnonymously().catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
            });

            firebase.auth().onAuthStateChanged(functino(user){

                if(user)
                {
                    // User is signed in
                    var isAnonymous = user.isAnonymous;
                    var uid = user.uid;
                    var userRef = app.dataInfo.child(app.users);

                    var useridRef = userRef.child(app.userid);

                    useridRef.set({
                        locations:"",
                        theme: "",
                        colorScheme:"",
                        food:""
                    });
                }
                else
                {
                    // User is signed out.
                }
            });
*/
        </script>
    </body>
</html>